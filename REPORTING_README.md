# Система отчетности Axenta CRM

Система отчетности предоставляет комплексную функциональность для создания, генерации и автоматической отправки отчетов по различным аспектам работы CRM системы.

## Возможности системы

### Основные функции

- ✅ Генерация отчетов по различным типам данных (объекты, пользователи, биллинг, монтажи, склад, договоры)
- ✅ Экспорт отчетов в форматах: CSV, Excel, PDF, JSON
- ✅ Система шаблонов для быстрого создания отчетов
- ✅ Автоматические отчеты по расписанию
- ✅ Отправка отчетов по email
- ✅ Фильтрация данных по периодам, статусам и другим параметрам
- ✅ Мультитенантность - изоляция данных между компаниями
- ✅ Подробная статистика и аналитика

## Архитектура системы

### Основные компоненты

1. **Models** (`models/report.go`)

   - `Report` - основная модель отчета
   - `ReportTemplate` - шаблоны отчетов
   - `ReportSchedule` - расписания автоматических отчетов
   - `ReportExecution` - выполнения отчетов по расписанию

2. **Services**

   - `ReportService` - генерация отчетов и экспорт в различные форматы
   - `ReportSchedulerService` - управление автоматическими отчетами

3. **API** (`api/reports.go`)
   - REST API для управления отчетами, шаблонами и расписаниями

## Типы отчетов

### 1. Отчет по объектам (`objects`)

Содержит информацию о всех объектах мониторинга:

- ID, название, тип объекта
- IMEI, телефон, адрес
- Статус, активность
- Привязка к договору и локации
- Дата создания

### 2. Отчет по пользователям (`users`)

Информация о пользователях системы:

- Имя пользователя, email, ФИО
- Роль, статус активности
- Статистика входов
- Дата создания

### 3. Отчет по биллингу (`billing`)

Финансовая информация:

- Счета, суммы, НДС
- Статусы платежей
- Даты создания и оплаты
- Количество позиций

### 4. Отчет по монтажам (`installations`)

Данные о монтажах и обслуживании:

- Объекты, монтажники, локации
- Даты, статусы, типы работ
- Продолжительность и стоимость

### 5. Отчет по складу (`warehouse`)

Складская информация:

- Оборудование, модели, серийные номера
- Категории, статусы, локации на складе
- Стоимость оборудования

### 6. Отчет по договорам (`contracts`)

Договорная информация:

- Номера договоров, клиенты
- Даты действия, статусы
- Стоимость, количество объектов

### 7. Общий отчет (`general`)

Сводная статистика по системе:

- Общее количество пользователей, объектов, договоров
- Активные/неактивные элементы
- Общая выручка

## Форматы экспорта

### CSV

- Простой текстовый формат с разделителями
- Подходит для импорта в другие системы
- Минимальный размер файла

### Excel (XLSX)

- Полнофункциональный табличный формат
- Поддержка автофильтров
- Удобен для анализа данных

### PDF

- Документ для печати и архивирования
- Ограниченное количество строк (до 50)
- Подходит для презентации

### JSON

- Структурированный формат данных
- Включает заголовки, данные и сводку
- Удобен для API интеграций

## API Endpoints

### Отчеты

```http
GET    /api/reports              # Список отчетов
POST   /api/reports              # Создать отчет
GET    /api/reports/:id          # Получить отчет
PUT    /api/reports/:id          # Обновить отчет
DELETE /api/reports/:id          # Удалить отчет

POST   /api/reports/:id/generate # Генерация отчета
GET    /api/reports/:id/download # Скачать отчет
GET    /api/reports/:id/status   # Статус генерации
```

### Шаблоны отчетов

```http
GET    /api/reports/templates        # Список шаблонов
POST   /api/reports/templates        # Создать шаблон
GET    /api/reports/templates/:id    # Получить шаблон
PUT    /api/reports/templates/:id    # Обновить шаблон
DELETE /api/reports/templates/:id    # Удалить шаблон
```

### Расписания отчетов

```http
GET    /api/reports/schedules        # Список расписаний
POST   /api/reports/schedules        # Создать расписание
GET    /api/reports/schedules/:id    # Получить расписание
PUT    /api/reports/schedules/:id    # Обновить расписание
DELETE /api/reports/schedules/:id    # Удалить расписание

POST   /api/reports/schedules/:id/run    # Запустить вручную
GET    /api/reports/schedules/:id/status # Статус расписания
```

### Выполнения и статистика

```http
GET /api/reports/executions     # Список выполнений
GET /api/reports/executions/:id # Детали выполнения
GET /api/reports/stats          # Статистика системы
```

## Примеры использования

### Создание отчета

```json
POST /api/reports
{
  "name": "Активные объекты за месяц",
  "description": "Отчет по всем активным объектам",
  "type": "objects",
  "format": "excel",
  "date_from": "2024-01-01T00:00:00Z",
  "date_to": "2024-01-31T23:59:59Z",
  "parameters": {
    "status": "active"
  }
}
```

### Создание шаблона отчета

```json
POST /api/reports/templates
{
  "name": "Шаблон активных объектов",
  "description": "Стандартный отчет по активным объектам",
  "type": "objects",
  "config": {
    "columns": ["id", "name", "type", "status", "location"]
  },
  "parameters": {
    "status": "active"
  },
  "headers": ["ID", "Название", "Тип", "Статус", "Локация"],
  "is_public": true
}
```

### Создание расписания отчета

```json
POST /api/reports/schedules
{
  "name": "Ежедневный отчет по объектам",
  "description": "Автоматический отчет каждый день в 9:00",
  "template_id": 1,
  "type": "daily",
  "time_of_day": "09:00",
  "format": "csv",
  "parameters": {
    "status": "all"
  },
  "recipients": ["manager@company.com", "admin@company.com"]
}
```

## Расписания отчетов

### Типы расписаний

- **daily** - ежедневно в указанное время
- **weekly** - еженедельно в указанный день недели
- **monthly** - ежемесячно в указанный день месяца
- **yearly** - ежегодно 1 января

### Параметры расписания

- `time_of_day` - время запуска (формат HH:MM)
- `day_of_week` - день недели (0-6, 0=воскресенье)
- `day_of_month` - день месяца (1-31)
- `cron_expression` - пользовательское cron выражение

### Автоматическая отправка

Система автоматически:

1. Генерирует отчет по расписанию
2. Отправляет его указанным получателям
3. Ведет лог выполнения и доставки
4. Обновляет статистику расписания

## Фильтрация и параметры

### Общие фильтры

- `date_from`, `date_to` - период данных
- `status` - статус записей
- `location_id` - фильтр по локации
- `user_id` - фильтр по пользователю

### Параметры запроса API

- `page`, `limit` - пагинация
- `type` - фильтр по типу отчета
- `status` - фильтр по статусу отчета
- `date_from`, `date_to` - фильтр по дате создания

## Безопасность и изоляция

### Мультитенантность

- Все данные изолированы по `company_id`
- Пользователи видят только отчеты своей компании
- Шаблоны могут быть публичными или приватными

### Права доступа

- Создание отчетов доступно всем авторизованным пользователям
- Удаление отчетов только создателем
- Управление шаблонами только создателем
- Публичные шаблоны доступны всем в компании

## Производительность

### Оптимизации

- Генерация отчетов в фоновых горутинах
- Кэширование часто используемых данных
- Индексы БД для быстрых запросов
- Пагинация больших результатов

### Ограничения

- PDF отчеты ограничены 50 строками
- Максимальный размер файла отчета - 100MB
- Таймаут генерации отчета - 30 минут

## Мониторинг и логирование

### Статистика системы

- Общее количество отчетов
- Успешные/неуспешные генерации
- Активные расписания
- История выполнений

### Логирование

- Все операции с отчетами логируются
- Ошибки генерации сохраняются в БД
- Статистика доставки email уведомлений

## Развертывание и настройка

### Зависимости

```go
// В go.mod добавлены:
github.com/xuri/excelize/v2    // Работа с Excel
github.com/jung-kurt/gofpdf    // Генерация PDF
github.com/robfig/cron/v3      // Планировщик задач
```

### Инициализация

```go
// В main.go
reportService := services.NewReportService(db)
schedulerService := services.NewReportSchedulerService(db, reportService, emailService)
reportsAPI := api.NewReportsAPI(db, reportService, schedulerService)

// Запуск планировщика
schedulerService.Start()
defer schedulerService.Stop()

// Регистрация роутов
v1 := router.Group("/api")
reportsAPI.RegisterRoutes(v1)
```

### Структура директорий

```
/reports/           # Директория для сгенерированных отчетов
  report_1_objects_20240115_143022.csv
  report_2_users_20240115_143045.xlsx
  ...
```

## Тестирование

### Unit тесты

- `services/report_service_test.go` - тесты сервиса генерации
- `api/reports_test.go` - тесты API endpoints

### Запуск тестов

```bash
# Все тесты отчетности
go test ./services -v -run TestReport
go test ./api -v -run TestReports

# Бенчмарки производительности
go test ./services -bench=BenchmarkReport
go test ./api -bench=BenchmarkReports
```

### Покрытие тестами

- Генерация всех типов отчетов
- Экспорт во все форматы
- API операции CRUD
- Валидация данных
- Изоляция между компаниями

## Примеры интеграции

### Интеграция с фронтендом

```javascript
// Создание отчета
const report = await fetch("/api/reports", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    name: "Объекты за текущий месяц",
    type: "objects",
    format: "excel",
    parameters: { status: "active" },
  }),
});

// Генерация отчета
await fetch(`/api/reports/${report.id}/generate`, { method: "POST" });

// Проверка статуса
const status = await fetch(`/api/reports/${report.id}/status`);
if (status.status === "completed") {
  // Скачивание
  window.location.href = `/api/reports/${report.id}/download`;
}
```

### Интеграция с внешними системами

```go
// Создание отчета через API
func createExternalReport(companyID uint, reportType string) error {
    params := services.ReportParams{
        Type:      models.ReportType(reportType),
        Format:    models.ReportFormatJSON,
        CompanyID: companyID,
    }

    report := models.Report{
        Name:        "External API Report",
        Type:        params.Type,
        Format:      params.Format,
        CompanyID:   companyID,
        CreatedByID: systemUserID,
    }

    return reportService.GenerateReport(params, &report)
}
```

## Заключение

Система отчетности Axenta CRM предоставляет мощный и гибкий инструмент для создания, генерации и автоматической отправки отчетов. Система поддерживает различные типы данных, форматы экспорта и расписания, обеспечивая при этом высокую производительность и безопасность.

Ключевые преимущества:

- ✅ Полная автоматизация процесса отчетности
- ✅ Гибкая система шаблонов и расписаний
- ✅ Множественные форматы экспорта
- ✅ Мультитенантная архитектура
- ✅ Высокая производительность
- ✅ Подробное тестирование и документация
