# Управление учетными записями компаний

Этот модуль предоставляет полнофункциональную систему управления учетными записями (компаниями) в Axenta CRM. Каждая компания представляет собой отдельную организацию с изолированными данными и настройками.

## Архитектура

### Backend (Go)

#### Модели данных

- **Company** (`models/company.go`) - основная модель компании с поддержкой мультитенантности
- Поддержка автоматического создания схем БД для каждой компании
- Шифрование паролей интеграций с помощью AES-GCM

#### API endpoints

Все endpoints находятся в группе `/api/admin/accounts`:

- `GET /accounts` - получение списка компаний с фильтрацией
- `POST /accounts` - создание новой компании
- `GET /accounts/:id` - получение компании по ID
- `PUT /accounts/:id` - обновление компании
- `DELETE /accounts/:id` - удаление компании (мягкое)
- `PUT /accounts/:id/activate` - активация компании
- `PUT /accounts/:id/deactivate` - деактивация компании
- `GET /accounts/:id/usage` - статистика использования ресурсов
- `POST /accounts/:id/test-connection` - тест подключения к Axenta API

#### Особенности

- Автоматическое создание схем БД при создании компании
- Валидация уникальности доменов
- Кэширование данных компаний в Redis
- Проверка активных пользователей/объектов при удалении
- Интеграция с middleware мультитенантности

### Frontend (Vue 3 + TypeScript)

#### Компоненты

- **Companies.vue** - главная страница управления компаниями
- **CompanyDialog.vue** - диалог создания/редактирования компаний
- **CompanyViewDialog.vue** - диалог просмотра детальной информации

#### Сервисы

- **companiesService.ts** - сервис для работы с API компаний
- Полная типизация TypeScript
- Валидация данных на клиенте
- Экспорт данных в CSV

#### Функциональность

- Список компаний с пагинацией и поиском
- Фильтрация по статусу активности
- Статистика использования ресурсов
- Формы с валидацией и вкладками
- Тестирование подключений к внешним API
- Экспорт данных
- Responsive дизайн

## Использование

### Создание новой компании

1. Перейдите на страницу "Учетные записи" (`/accounts`)
2. Нажмите кнопку "Добавить компанию"
3. Заполните обязательные поля:
   - Название компании
   - Логин Axenta
   - Пароль Axenta
4. При необходимости заполните дополнительные вкладки:
   - **Контакты** - контактная информация
   - **Интеграции** - настройки Битрикс24
   - **Настройки** - лимиты ресурсов и локализация

### Управление компаниями

#### Просмотр списка

- Используйте поиск для быстрого поиска компаний
- Фильтруйте по статусу активности
- Настраивайте количество записей на странице

#### Действия с компаниями

- **Просмотр** - детальная информация о компании
- **Редактирование** - изменение настроек компании
- **Тест подключения** - проверка доступности Axenta API
- **Активация/деактивация** - управление статусом компании
- **Удаление** - удаление компании (с проверкой активных данных)

#### Мониторинг ресурсов

В карточке компании отображается:

- Количество пользователей (текущее/максимум)
- Количество объектов (текущее/максимум)
- Использование хранилища (текущее/квота)
- Последняя активность

### Экспорт данных

Нажмите кнопку "Экспорт" для скачивания CSV файла со списком компаний. Экспорт учитывает примененные фильтры.

## Безопасность

### Шифрование данных

- Пароли интеграций шифруются с помощью AES-GCM
- Чувствительные данные не передаются в JSON ответах
- Кэширование с автоматическим истечением

### Права доступа

- Требуется разрешение `admin.companies.read` для доступа к интерфейсу
- Административные endpoints вынесены в отдельную группу `/api/admin/`
- Валидация данных на клиенте и сервере

## Мультитенантность

### Изоляция данных

- Каждая компания получает отдельную схему БД
- Автоматическое переключение схем через middleware
- Полная изоляция данных между компаниями

### Схемы БД

- Автоматическая генерация имен схем: `tenant_<random>`
- Выполнение миграций для новых схем
- Проверка валидности схем при активации

## Интеграции

### Axenta.cloud API

- Обязательные учетные данные для каждой компании
- Тестирование подключения через API
- Автоматическая проверка валидности токенов

### Битрикс24 (опционально)

- Настройка вебхуков и OAuth приложений
- Хранение зашифрованных Client Secret
- Поддержка различных доменов Битрикс24

## Тестирование

### Backend тесты

```bash
cd backend_axenta
go test ./api/ -v -run TestCompanies
```

### Frontend тесты

```bash
cd frontend_axenta
npm run test companies.e2e.test.ts
```

### Покрытие тестами

- CRUD операции с компаниями
- Валидация данных
- Шифрование/дешифрование паролей
- Экспорт данных
- Обработка ошибок
- Интеграционные сценарии

## Конфигурация

### Переменные окружения

```env
# Ключ шифрования (32 байта)
ENCRYPTION_KEY=your-32-byte-encryption-key

# Redis для кэширования
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# PostgreSQL для основной БД
DATABASE_URL=postgres://user:pass@localhost/axenta
```

### Настройки по умолчанию

- Максимум пользователей: 10
- Максимум объектов: 100
- Квота хранилища: 1024 МБ
- Язык: русский
- Часовой пояс: Europe/Moscow
- Валюта: RUB

## Производительность

### Оптимизации

- Кэширование данных компаний в Redis (TTL 15 минут)
- Debounced поиск на фронтенде (500ms)
- Пагинация с настраиваемым размером страницы
- Ленивая загрузка статистики использования

### Мониторинг

- Логирование всех операций с компаниями
- Метрики времени выполнения запросов
- Отслеживание ошибок интеграций

## Troubleshooting

### Частые проблемы

1. **Ошибка создания схемы БД**

   - Проверьте права пользователя PostgreSQL
   - Убедитесь в корректности имени схемы

2. **Ошибка тестирования подключения**

   - Проверьте доступность axenta.cloud
   - Убедитесь в корректности учетных данных

3. **Проблемы с кэшированием**
   - Проверьте подключение к Redis
   - Очистите кэш компании вручную

### Логи

Все операции логируются с префиксом `[COMPANIES]`:

```
[COMPANIES] Company created: ID=123, Name="Test Company"
[COMPANIES] Schema created: tenant_abc123
[COMPANIES] Connection test failed: Invalid credentials
```

## Roadmap

### Планируемые улучшения

- Импорт компаний из CSV/Excel
- Массовые операции (активация/деактивация)
- Шаблоны компаний для быстрого создания
- Интеграция с системой уведомлений
- API для внешних систем управления
- Расширенная аналитика использования ресурсов
