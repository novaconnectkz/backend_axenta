# Интеграция с Битрикс24

## Описание

Система интеграции с Битрикс24 позволяет синхронизировать данные между CRM-системой Axenta и порталом Битрикс24. Интеграция поддерживает двустороннюю синхронизацию контактов, сделок и связанных данных.

## Возможности

- **Синхронизация объектов** → Сделки в Битрикс24
- **Синхронизация пользователей** → Контакты в Битрикс24
- **Двусторонняя синхронизация** - обновления из Битрикс24 в локальную систему
- **Автоматическая синхронизация** при создании/обновлении записей
- **Обработка ошибок** с системой повторных попыток
- **Мониторинг интеграции** с детальной статистикой

## Архитектура

### Основные компоненты

1. **Bitrix24Client** - HTTP клиент для работы с API Битрикс24
2. **Bitrix24IntegrationService** - сервис интеграции с бизнес-логикой
3. **Bitrix24SyncMapping** - модель маппинга между локальными и внешними ID
4. **API endpoints** - REST API для управления интеграцией

### Схема данных

```sql
-- Маппинг синхронизации
CREATE TABLE bitrix24_sync_mappings (
    id SERIAL PRIMARY KEY,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    tenant_id INTEGER NOT NULL,
    local_type VARCHAR(50) NOT NULL,  -- object, user, contract
    local_id INTEGER NOT NULL,
    bitrix24_type VARCHAR(50) NOT NULL,  -- contact, deal, company
    bitrix24_id VARCHAR(100) NOT NULL,
    last_sync_at TIMESTAMP,
    sync_direction VARCHAR(20)  -- to_bitrix, from_bitrix, bidirectional
);

-- Дополнительные поля в таблице companies
ALTER TABLE companies ADD COLUMN bitrix24_webhook_url VARCHAR(500);
ALTER TABLE companies ADD COLUMN bitrix24_client_id VARCHAR(100);
ALTER TABLE companies ADD COLUMN bitrix24_client_secret VARCHAR(200);
```

## Настройка интеграции

### 1. Получение вебхука в Битрикс24

1. Зайдите в ваш портал Битрикс24
2. Перейдите в **Разработчикам** → **Другое** → **Входящий вебхук**
3. Создайте новый вебхук с правами:
   - `crm` - для работы с CRM
   - `user` - для работы с пользователями (опционально)
4. Скопируйте URL вебхука

### 2. Настройка через API

```bash
curl -X POST http://localhost:8080/api/integration/bitrix24/setup \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "webhook_url": "https://your-portal.bitrix24.com/rest/1/webhook_key/",
    "client_id": "optional_app_id",
    "client_secret": "optional_app_secret"
  }'
```

### 3. Проверка настройки

```bash
curl -X GET http://localhost:8080/api/integration/bitrix24/health \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## API Endpoints

### Настройка интеграции

- `POST /api/integration/bitrix24/setup` - Настройка интеграции
- `GET /api/integration/bitrix24/health` - Проверка состояния интеграции

### Синхронизация данных

- `POST /api/integration/bitrix24/sync/to` - Синхронизация в Битрикс24
- `POST /api/integration/bitrix24/sync/from` - Синхронизация из Битрикс24

### Мониторинг

- `GET /api/integration/bitrix24/mappings` - Список маппингов синхронизации
- `GET /api/integration/bitrix24/stats` - Статистика интеграции

### Управление

- `DELETE /api/integration/bitrix24/cache` - Очистка кэша интеграции

## Использование

### Настройка синхронизации в Битрикс24

```bash
# Синхронизировать все объекты и пользователей
curl -X POST http://localhost:8080/api/integration/bitrix24/sync/to \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "sync_objects": true,
    "sync_users": true,
    "direction": "to_bitrix"
  }'
```

### Получение статистики

```bash
curl -X GET http://localhost:8080/api/integration/bitrix24/stats \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

Ответ:

```json
{
  "status": "success",
  "data": {
    "mappings": {
      "total_mappings": 25,
      "object_mappings": 15,
      "user_mappings": 10,
      "contract_mappings": 0,
      "last_sync_time": "2024-01-27T10:30:00Z"
    },
    "errors_count": 2,
    "service_name": "Битрикс24",
    "generated_at": "2024-01-27T10:35:00Z"
  }
}
```

### Получение маппингов

```bash
curl -X GET "http://localhost:8080/api/integration/bitrix24/mappings?page=1&limit=10" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Автоматическая синхронизация

Система автоматически синхронизирует данные при:

- **Создании объекта** - автоматически создается сделка в Битрикс24
- **Обновлении объекта** - обновляется соответствующая сделка
- **Создании пользователя** - создается контакт в Битрикс24
- **Обновлении пользователя** - обновляется соответствующий контакт

### Отключение автосинхронизации

Автоматическая синхронизация работает только если настроен `webhook_url` в настройках компании. Для отключения удалите URL вебхука из настроек.

## Маппинг данных

### Объекты CRM → Сделки Битрикс24

| Поле CRM                      | Поле Битрикс24           | Описание                             |
| ----------------------------- | ------------------------ | ------------------------------------ |
| `Name`                        | `TITLE`                  | Название объекта как название сделки |
| `Description`, `IMEI`, `Type` | `COMMENTS`               | Объединяются в комментарий           |
| `ContractID`                  | `TITLE`, `COMMENTS`      | Информация о договоре                |
| Contract dates                | `BEGINDATE`, `CLOSEDATE` | Даты договора                        |

### Пользователи CRM → Контакты Битрикс24

| Поле CRM                    | Поле Битрикс24 | Описание             |
| --------------------------- | -------------- | -------------------- |
| `Name` (первое слово)       | `NAME`         | Имя пользователя     |
| `Name` (остальные слова)    | `LAST_NAME`    | Фамилия пользователя |
| `Email`                     | `EMAIL`        | Email адрес          |
| `Phone`                     | `PHONE`        | Номер телефона       |
| `Role`, создание/обновление | `COMMENTS`     | Роль и метаданные    |

## Обработка ошибок

### Типы ошибок

1. **Ошибки авторизации** - неверный вебхук или истекшие права
2. **Ошибки сети** - недоступность API Битрикс24
3. **Ошибки валидации** - некорректные данные
4. **Ошибки лимитов** - превышение лимитов API

### Система повторных попыток

- **Автоматические повторы** для сетевых ошибок
- **Экспоненциальный backoff** с максимальной задержкой 1 час
- **Максимум 3 попытки** для каждой операции
- **Логирование ошибок** в таблицу `integration_errors`

### Мониторинг ошибок

```bash
# Получить статистику ошибок
curl -X GET http://localhost:8080/api/integration/errors/stats \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Получить список ошибок
curl -X GET http://localhost:8080/api/integration/errors \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Производительность

### Оптимизации

- **Кэширование учетных данных** - избегаем повторных авторизаций
- **Пакетная обработка** - получение списков по 50 записей
- **Асинхронная синхронизация** - не блокирует основные операции
- **Защита от дублирования** - предотвращение циклических синхронизаций

### Лимиты API

- **Битрикс24 REST API** - до 2 запросов в секунду
- **Batch запросы** - до 50 операций за раз
- **Timeout** - 30 секунд на запрос

## Безопасность

### Защита данных

- **Скрытие в JSON** - вебхук и ключи не отображаются в API
- **HTTPS только** - все запросы к Битрикс24 через защищенное соединение
- **Валидация входных данных** - проверка всех параметров
- **Изоляция компаний** - каждая компания видит только свои данные

### Логирование

Все операции интеграции логируются с информацией:

- ID компании (tenant_id)
- Тип операции (create, update, sync)
- Результат операции
- Время выполнения
- Ошибки и стек трейсы

## Тестирование

### Unit тесты

```bash
# Запуск тестов интеграции
go test ./services -run TestBitrix24 -v

# Запуск бенчмарков
go test ./services -bench BenchmarkBitrix24 -v
```

### Интеграционные тесты

Используется мок-клиент для тестирования без реальных вызовов к API:

```go
// Пример использования мок-клиента
mockClient := NewMockBitrix24Client()
service.Bitrix24Client = mockClient

// Настройка ошибок для тестирования
mockClient.SetShouldFail(true, "Test error")
```

## Мониторинг и отладка

### Логи

Логи интеграции имеют префикс `[BITRIX24]` и включают:

```
[BITRIX24] 2024/01/27 10:30:00 Получены учетные данные для компании 1
[BITRIX24] 2024/01/27 10:30:01 Объект 123 успешно синхронизирован с Битрикс24 как сделка 456
[BITRIX24] 2024/01/27 10:30:02 Ошибка синхронизации объекта 124: недоступен API
```

### Метрики

- Количество успешных синхронизаций
- Количество ошибок по типам
- Время последней синхронизации
- Статистика по маппингам

### Проверка состояния

```bash
# Быстрая проверка доступности
curl -X GET http://localhost:8080/api/integration/bitrix24/health \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Подробная статистика
curl -X GET http://localhost:8080/api/integration/bitrix24/stats \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Устранение неполадок

### Частые проблемы

1. **"Компания не настроена для интеграции с Битрикс24"**

   - Проверьте настройку вебхука через `/integration/bitrix24/setup`
   - Убедитесь, что URL вебхука корректный

2. **"Ошибка проверки вебхука Битрикс24"**

   - Проверьте доступность портала Битрикс24
   - Убедитесь в правильности URL вебхука
   - Проверьте права доступа вебхука

3. **"Синхронизация уже выполняется"**

   - Система защищает от параллельных синхронизаций
   - Дождитесь завершения текущей операции

4. **Медленная синхронизация**
   - Проверьте лимиты API Битрикс24
   - Уменьшите размер пакетов данных
   - Проверьте сетевое соединение

### Отладка

1. **Включите подробное логирование**:

   ```bash
   export LOG_LEVEL=debug
   ```

2. **Проверьте маппинги**:

   ```bash
   curl -X GET http://localhost:8080/api/integration/bitrix24/mappings \
     -H "Authorization: Bearer YOUR_JWT_TOKEN"
   ```

3. **Очистите кэш**:
   ```bash
   curl -X DELETE http://localhost:8080/api/integration/bitrix24/cache \
     -H "Authorization: Bearer YOUR_JWT_TOKEN"
   ```

## Развитие

### Планируемые функции

- Поддержка OAuth 2.0 авторизации
- Синхронизация компаний
- Интеграция с задачами Битрикс24
- Webhook'и для real-time синхронизации
- Расширенные фильтры синхронизации

### Вклад в развитие

При добавлении новых функций интеграции:

1. Следуйте существующим паттернам архитектуры
2. Добавляйте unit тесты для новых функций
3. Обновляйте документацию
4. Тестируйте с реальным API Битрикс24

## Поддержка

Для получения поддержки по интеграции с Битрикс24:

1. Проверьте логи системы
2. Используйте endpoint'ы мониторинга
3. Обратитесь к документации Битрикс24 REST API
4. Создайте issue с детальным описанием проблемы
